<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <title>Game Anh Tài V28 - Auto Sync Version</title>
    <style>
        :root { --bg: #0a0a0a; --accent: #f1c40f; --card-w: 72px; --card-h: 100px; --panel-bg: #111; }
        body { font-family: 'Segoe UI', sans-serif; background: var(--bg); color: white; margin: 0; overflow: hidden; }
        #admin-panel { background: #1a1a1a; padding: 15px; border-bottom: 3px solid #333; height: auto; max-height: 90vh; overflow-y: auto; z-index: 1000; position: relative; }
        .admin-grid { display: grid; grid-template-columns: 1.2fr 1fr 1fr; gap: 15px; }
        .box { background: #222; padding: 12px; border-radius: 8px; border: 1px solid #444; }
        .scroll-v { height: 350px; overflow-y: auto; background: #000; padding: 8px; border-radius: 5px; scrollbar-width: thin; }
        .team-item { background: #333; margin-bottom: 5px; padding: 8px; border-radius: 5px; border-left: 3px solid var(--accent); }
        #game-screen { display: grid; grid-template-columns: 260px 1fr 240px; height: 100vh; background: #050505; }
        .rules-sidebar { background: var(--panel-bg); border-right: 1px solid #333; padding: 15px; overflow-y: auto; font-size: 13px; color: #ddd; line-height: 1.5; scrollbar-width: thin; }
        .rules-sidebar h3 { color: var(--accent); margin-top: 0; text-align: center; border-bottom: 2px solid #333; padding-bottom: 10px; }
        .play-main { display: flex; flex-direction: column; height: 100vh; position: relative; overflow: hidden; justify-content: center; align-items: center; gap: 15px; }
        .right-controls { position: absolute; right: 10px; top: 50%; transform: translateY(-50%); display: flex; flex-direction: column; gap: 15px; align-items: center; z-index: 100; }
        .circle-ui { width: 70px; height: 70px; border-radius: 50%; background: #222; border: 3px solid #444; display: flex; flex-direction: column; justify-content: center; align-items: center; font-weight: bold; box-shadow: 0 4px 10px rgba(0,0,0,0.5); }
        #timer-val { font-size: 32px; color: var(--accent); }
        .timer-label { font-size: 8px; color: #888; margin-top: -5px; }
        #turn-indicator { font-size: 12px; text-align: center; line-height: 1.2; }
        .p-active { border-color: #2ecc71; color: #2ecc71; box-shadow: 0 0 10px rgba(46, 204, 113, 0.3); }
        .ai-active { border-color: #ff4757; color: #ff4757; box-shadow: 0 0 10px rgba(255, 71, 87, 0.3); }
        #draw-pile { width: 75px; height: 105px; border: 2px solid #444; border-radius: 8px; cursor: pointer; background-color: #1a1a1a; background-size: cover; background-position: center; display: flex; justify-content: center; align-items: center; transition: 0.2s; position: relative; }
        #draw-count { font-size: 24px; font-weight: bold; color: #fff; text-shadow: 0 0 5px #000; z-index: 2; }
        .play-area { display: flex; flex-direction: column; justify-content: center; align-items: center; padding: 0; width: 100%; flex: 0 0 auto; }
        .card-row-scroll { display: flex; flex-wrap: nowrap; gap: 8px; overflow-x: auto; overflow-y: hidden; width: 100%; max-width: 650px; padding: 8px 2px; min-height: 115px; scrollbar-width: thin; align-items: center; justify-content: flex-start; margin: 0 auto; }
        .captured-zone { width: 95%; max-width: 650px; display: flex; flex-direction: column; gap: 2px; margin: 0 auto; }
        .captured-list { display: flex; gap: 4px; overflow-x: auto; width: 100%; height: 75px; background: rgba(255,255,255,0.03); border-radius: 5px; padding: 4px; align-items: center; scrollbar-width: thin; }
        .zone-label { font-size: 11px; color: var(--accent); font-weight: bold; margin-left: 5px; display: flex; justify-content: space-between; padding-right: 10px;}
        .card { width: var(--card-w); height: var(--card-h); background: #fff; border-radius: 6px; overflow: hidden; cursor: pointer; transition: 0.2s; border: 2px solid transparent; flex-shrink: 0; position: relative; }
        .card img { width: 100%; height: 100%; object-fit: cover; pointer-events: none; } 
        .card .c-img-front { height: 78%; }
        .card .c-name { height: 22%; color: #000; font-size: 9px; font-weight: bold; text-align: center; display: flex; align-items: center; justify-content: center; background: #fff; padding: 0 2px; line-height: 1.1; }
        .card.selected { transform: scale(1.05); border-color: var(--accent); z-index: 10; }
        .card.highlight { border-color: #2ecc71; animation: pulse 1s infinite; }
        .card.team-done { border-color: #ff4757; box-shadow: 0 0 5px #ff4757; }
        .card-mini { width: 45px; height: 64px; border-radius: 4px; flex-shrink: 0; }
        .card-mini .c-name { font-size: 7px; display: flex; height: 25%; }
        .modal-overlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.9); z-index: 999; display: flex; justify-content: center; align-items: center; }
        .modal-content { background: #222; padding: 20px; border-radius: 12px; border: 2px solid var(--accent); text-align: center; width: 300px; }
        .side-bar { padding: 10px; background: #111; overflow-y: auto; display: flex; flex-direction: column; gap: 8px; scrollbar-width: thin; border-left: 1px solid #222; }
        .team-tag { padding: 5px; border: 1px solid #333; border-radius: 4px; color: #666; font-size: 11px; text-align: center; background: #151515; }
        .team-tag.active { border-color: #ff4757; color: #ff4757; background: rgba(255, 71, 87, 0.1); font-weight: bold; }
        .btn { color: white; border: none; padding: 8px; border-radius: 5px; cursor: pointer; font-weight: bold; width: 100%; font-size: 12px; }
        .hidden { display: none !important; }
        @keyframes pulse { 0% { opacity: 0.7; } 100% { opacity: 1; } }
    </style>
</head>
<body>

<div id="decision-modal" class="modal-overlay hidden">
    <div class="modal-content">
        <h3 style="color:var(--accent); margin:0;">BẠN RÚT ĐƯỢC</h3>
        <img id="modal-img" style="width:90px; height:125px; margin:15px auto; border:2px solid white; display:block; object-fit: cover;" src="">
        <div style="display:flex; gap:10px;"><button class="btn" style="background:#2ecc71; flex:1;" onclick="resolveDraw(true)">OK DỨT</button><button class="btn" style="background:#e74c3c; flex:1;" onclick="resolveDraw(false)">TẠM XA NHAU</button></div>
    </div>
</div>

<div id="pause-modal" class="modal-overlay hidden"><div class="modal-content"><h2 style="color:var(--accent);">☕ NGHỈ GIẢI LAO</h2><button class="btn" style="background:#3498db;" onclick="resumeGame()">OK TIẾP TỤC ▶</button></div></div>
<div id="reset-modal" class="modal-overlay hidden"><div class="modal-content"><h2 style="color:#ff4757;">⚠️ CẢNH BÁO</h2><p>Chắc chưa?</p><div style="display:flex; gap:10px;"><button class="btn" style="background:#e74c3c; flex:1;" onclick="confirmReset()">CHẮC RỒI</button><button class="btn" style="background:#95a5a6; flex:1;" onclick="closeReset()">THÔI CHƠI TIẾP</button></div></div></div>

<div id="admin-panel">
    <div style="display:flex; justify-content: space-between; margin-bottom:10px;"><h2 style="color:var(--accent); margin:0;">ADMIN - QUẢN LÝ DỮ LIỆU</h2><button class="btn" style="background:#2ecc71; width:auto;" onclick="startGame()">VÀO CHƠI LUÔN</button></div>
    <div class="admin-grid">
        <div class="box"><strong>1. Link ảnh:</strong><div style="margin-bottom:10px;">Mặt sau: <input type="text" id="back-card-url" oninput="cardBack=this.value;saveData()" style="width:70%; background:#111; color:#fff;"></div><div id="at-album" class="scroll-v" style="height:250px;"></div></div>
        <div class="box"><strong>2. Tạo Team:</strong><input type="text" id="t-name" placeholder="Tên Team..." style="width:90%; margin:5px 0;"><div id="at-checklist" class="scroll-v" style="height:220px;"></div><button class="btn" style="background:#3498db;" onclick="addTeam()">+ LƯU NHÓM</button></div>
        <div class="box"><strong>3. Đã lưu:</strong><div id="team-list" class="scroll-v"></div></div>
    </div>
</div>

<div id="game-screen" class="hidden">
    <div class="rules-sidebar"><h3>LUẬT CHƠI</h3><strong>Mục tiêu:</strong> Thu thập team đủ bộ để ghi điểm.<br>+1đ mỗi lá, +5đ mỗi team đủ, -2đ mỗi lá lẻ khi kết thúc.<br>Hết bài tay bắt buộc rút bài úp.</div>
    <div class="play-main">
        <div class="play-area"><div id="ai-hand" class="card-row-scroll"></div><div class="captured-zone"><div class="zone-label"><span>Đã tìm thấy nhau (AI)</span> <span id="score-ai" style="color:#ff4757">0</span></div><div id="ai-captured" class="captured-list"></div></div></div>
        <div class="play-area"><div id="board" class="card-row-scroll"></div></div>
        <div class="play-area"><div class="captured-zone"><div class="zone-label"><span>Đã tìm thấy nhau (Bạn)</span> <span id="score-p" style="color:#2ecc71">0</span></div><div id="p-captured" class="captured-list"></div></div><div id="p-hand" class="card-row-scroll"></div></div>
        <div class="right-controls"><div class="circle-ui"><div id="timer-val">15</div><div class="timer-label">GIÂY</div></div><div id="turn-circle" class="circle-ui p-active"><div id="turn-indicator">GAI<br>CON</div></div><div id="draw-pile" onclick="playerDraw()"><span id="draw-count"></span></div></div>
    </div>
    <div class="side-bar"><h4 style="text-align:center; color:var(--accent);">TIẾN ĐỘ TEAM</h4><div id="side-teams" class="scroll-v" style="height:450px;"></div><button class="btn" style="background:#3498db;" onclick="togglePause()">Tạm dừng</button><button class="btn" style="background:#9b59b6;" onclick="resetGame()">Làm lại</button></div>
</div>

<script>
    const AT_NAMES = ["Hồng Sơn","Bằng Kiều","Tự Long","Phan Đinh Tùng","Tuấn Hưng","Đinh Tiến Đạt","Phạm Khánh Hưng","Tiến Luật","Thành Trung","Đăng Khôi","Trương Thế Vinh","Hà Lê","Đỗ Hoàng Hiệp","Thanh Duy","Quốc Thiên","Binz","Cường Seven","Nguyễn Trần Duy Nhất","Jun Phạm","Neko Lê","Tăng Phúc","Thiên Minh","BB Trần","Liên Bỉnh Phát","S.T Sơn Thạch","Rhymastic","Kiên Ứng","(S)TRONG Trọng Hiếu","Soobin Hoàng Sơn","Kay Trần","Bùi Công Nam","Duy Khánh","HuyR","Anh Tuấn","SLIMV","Đinh Hà Uyên Thư","Vĩ Khang","Long Kenji","Khánh Vy","Nhà Đam Mê","Nhà KK","Nhà Sao Sáng","Nhà Tái Sinh","Nhà Ngũ Hành","Nhà Hát","Nhà Xuân Hạ Thu Đông","Nhà Xương Rồng","Gai Con","Concert","Hỏa Ca"];
    let teams = [], at_images = {}, cardBack = "", isPaused = false;
    let game = { pHand:[], aiHand:[], board:[], deck:[], pCap:[], aiCap:[], turn:'p', selected:null, time:15, iv:null };

    function drive(url) { if(!url || !url.includes('drive.google.com')) return url; let id = url.split('/d/')[1]?.split('/')[0] || url.split('id=')[1]?.split('&')[0]; return `https://lh3.googleusercontent.com/d/${id}`; }

    // TỰ ĐỘNG ĐỒNG BỘ TỪ FILE data.json TRÊN VERCEL
    window.onload = async () => {
        try {
            const res = await fetch('./data.json'); // Tìm file data.json cùng thư mục trên GitHub/Vercel
            if (res.ok) {
                const data = await res.json();
                at_images = data.images || {};
                teams = data.teams || [];
                cardBack = data.cardBack || "";
                console.log("Đã đồng bộ dữ liệu từ GitHub!");
            }
        } catch (e) { console.log("Dùng dữ liệu tạm thời."); }
        renderAdmin();
    };

    function renderAdmin() {
        document.getElementById('back-card-url').value = cardBack;
        document.getElementById('at-album').innerHTML = AT_NAMES.map((n, i) => `<div style="font-size:10px;">${i+1}. ${n} <input type="text" value="${at_images[i+1] || ''}" oninput="at_images[${i+1}]=this.value;saveData()" style="width:60%; background:#111; color:#fff;"></div>`).join('');
        document.getElementById('at-checklist').innerHTML = AT_NAMES.map((n, i) => `<div><input type="checkbox" value="${i+1}" class="chk-at"> ${n}</div>`).join('');
        renderTeamList();
    }

    function addTeam() {
        const name = document.getElementById('t-name').value;
        const ids = Array.from(document.querySelectorAll('.chk-at:checked')).map(cb => parseInt(cb.value));
        if(!name || ids.length < 2) return;
        teams.push({ name, members: ids });
        renderTeamList(); saveData();
    }

    function renderTeamList() { document.getElementById('team-list').innerHTML = teams.map((t, i) => `<div class="team-item"><strong>${t.name}</strong><span onclick="teams.splice(${i},1);renderTeamList();saveData()" style="color:#ff4757; float:right; cursor:pointer;">X</span></div>`).join(''); }
    function saveData() { localStorage.setItem('at_v23_data', JSON.stringify({ images: at_images, teams: teams, cardBack: cardBack })); }

    function startGame() {
        document.getElementById('admin-panel').classList.add('hidden');
        document.getElementById('game-screen').classList.remove('hidden');
        let fullDeck = AT_NAMES.map((n, i) => ({ id: i+1, name: n, img: drive(at_images[i+1]) }));
        fullDeck.sort(() => Math.random() - 0.5);
        game.pHand = fullDeck.splice(0, 7); game.aiHand = fullDeck.splice(0, 7);
        game.board = fullDeck.splice(0, 8); game.deck = fullDeck;
        game.pCap = []; game.aiCap = []; game.turn = 'p';
        document.getElementById('side-teams').innerHTML = teams.map(t => `<div id="tag-${t.name.replace(/\s/g,'')}" class="team-tag">${t.name}</div>`).join('');
        updateUI(); startTimer();
    }

    function calculateScore(captured, isFinal = false) {
        let s = captured.length;
        teams.forEach(t => { if(t.members.every(mId => captured.some(c => c.id === mId))) s += 5; });
        if(isFinal) { captured.forEach(c => { let linked = false; teams.filter(t => t.members.includes(c.id)).forEach(t => { if(t.members.every(mId => captured.some(cap => cap.id === mId))) linked = true; }); if(!linked) s -= 2; }); }
        return s;
    }

    function updateUI() {
        document.getElementById('score-p').innerText = calculateScore(game.pCap);
        document.getElementById('score-ai').innerText = calculateScore(game.aiCap);
        const tc = document.getElementById('turn-circle');
        document.getElementById('turn-indicator').innerHTML = game.turn === 'p' ? "GAI<br>CON" : "ANH<br>TÀI";
        tc.className = game.turn === 'p' ? "circle-ui p-active" : "circle-ui ai-active";
        const pile = document.getElementById('draw-pile');
        document.getElementById('draw-count').innerText = game.deck.length;
        if(cardBack) pile.style.backgroundImage = `url('${drive(cardBack)}')`;
        const cardH = (c, isP) => `<div class="card ${game.selected === c.id ? 'selected' : ''}" onclick="${isP ? `selectCard(${c.id})` : ''}"><img class="c-img-front" src="${c.img}"><div class="c-name">${c.name}</div></div>`;
        const aiH = cardBack ? `<div class="card"><img src="${drive(cardBack)}"></div>` : `<div class="card" style="background:#222;"></div>`;
        document.getElementById('p-hand').innerHTML = game.pHand.map(c => cardH(c, true)).join('');
        document.getElementById('ai-hand').innerHTML = game.aiHand.map(() => aiH).join('');
        document.getElementById('board').innerHTML = game.board.map(c => {
            const hasM = game.pCap.some(pc => teams.some(t => t.members.includes(pc.id) && t.members.includes(c.id)));
            return `<div class="card ${hasM ? 'highlight' : ''}" onclick="takeCard(${c.id})"><img class="c-img-front" src="${c.img}"><div class="c-name">${c.name}</div></div>`;
        }).join('');
        const mini = (c) => `<div class="card card-mini"><img src="${c.img}"><div class="c-name">${c.name}</div></div>`;
        document.getElementById('p-captured').innerHTML = game.pCap.map(mini).join('');
        document.getElementById('ai-captured').innerHTML = game.aiCap.map(mini).join('');
        teams.forEach(t => { const ok = t.members.every(mId => [...game.pCap, ...game.aiCap].some(c => c.id === mId)); const el = document.getElementById(`tag-${t.name.replace(/\s/g,'')}`); if(el) el.className = ok ? 'team-tag active' : 'team-tag'; });
        checkEndGame();
    }

    function selectCard(id) { if(game.turn === 'p') { game.selected = (game.selected === id) ? null : id; updateUI(); } }

    function takeCard(bId) {
        if(game.turn !== 'p' || isPaused) return;
        const bc = game.board.find(x => x.id === bId);
        const mMatch = game.pCap.some(pc => teams.some(t => t.members.includes(pc.id) && t.members.includes(bId)));
        if(mMatch) { game.pCap.push(bc); game.board = game.board.filter(x => x.id !== bId); nextTurn(); return; }
        if(game.selected) { const match = teams.some(t => t.members.includes(game.selected) && t.members.includes(bId)); if(match) { game.pCap.push(bc, game.pHand.find(x => x.id === game.selected)); game.board = game.board.filter(x => x.id !== bId); game.pHand = game.pHand.filter(x => x.id !== game.selected); game.selected = null; nextTurn(); } }
    }

    function playerDraw() { if(game.turn !== 'p' || isPaused || game.deck.length === 0) return; clearInterval(game.iv); game.tempDraw = game.deck.shift(); document.getElementById('decision-modal').classList.remove('hidden'); document.getElementById('modal-img').src = game.tempDraw.img; }
    function resolveDraw(isK) { document.getElementById('decision-modal').classList.add('hidden'); let c = game.tempDraw; if(isK) { let match = game.board.find(bc => teams.some(t => t.members.includes(c.id) && t.members.includes(bc.id))); if(match) { game.pCap.push(c, match); game.board = game.board.filter(x => x.id !== match.id); } else { game.pHand.push(c); } } else { game.board.push(c); } game.tempDraw = null; nextTurn(); }
    function startTimer() { clearInterval(game.iv); game.time = 15; document.getElementById('timer-val').innerText = game.time; game.iv = setInterval(() => { if(!isPaused) { game.time--; document.getElementById('timer-val').innerText = game.time; if(game.turn === 'ai' && game.time === 7) aiMove(); if(game.time <= 0) nextTurn(); } }, 1000); }
    function nextTurn() { game.turn = (game.turn === 'p' ? 'ai' : 'p'); updateUI(); startTimer(); }
    function aiMove() { if(game.aiHand.length === 0 && game.deck.length > 0) { let c = game.deck.shift(); let bIdx = game.board.findIndex(bc => teams.some(t => t.members.includes(c.id) && t.members.includes(bc.id))); if(bIdx > -1) game.aiCap.push(c, game.board.splice(bIdx,1)[0]); else game.aiHand.push(c); nextTurn(); return; } let mIdx = game.board.findIndex(bc => game.aiCap.some(ac => teams.some(t => t.members.includes(ac.id) && t.members.includes(bc.id)))); if(mIdx > -1) game.aiCap.push(game.board.splice(mIdx,1)[0]); else { let eaten = false; for(let bc of game.board) { let mIdx = game.aiHand.findIndex(ah => teams.some(t => t.members.includes(bc.id) && t.members.includes(ah.id))); if(mIdx > -1) { game.aiCap.push(bc, game.aiHand.splice(mIdx,1)[0]); game.board = game.board.filter(x => x.id !== bc.id); eaten = true; break; } } if(!eaten && game.deck.length > 0) { let c = game.deck.shift(); let bIdx = game.board.findIndex(bc => teams.some(t => t.members.includes(c.id) && t.members.includes(bc.id))); if(bIdx > -1) game.aiCap.push(c, game.board.splice(bIdx,1)[0]); else game.aiHand.push(c); } } nextTurn(); }
    function checkEndGame() { if((game.board.length === 0 && game.deck.length === 0) || (game.deck.length === 0 && (game.pHand.length === 0 || game.aiHand.length === 0))) { clearInterval(game.iv); let pF = calculateScore(game.pCap, true), aF = calculateScore(game.aiCap, true); setTimeout(() => alert(`Kết thúc!\nBạn: ${pF}đ\nAI: ${aF}đ`), 500); } }
    function togglePause() { isPaused = true; document.getElementById('pause-modal').classList.remove('hidden'); }
    function resumeGame() { isPaused = false; document.getElementById('pause-modal').classList.add('hidden'); }
    function resetGame() { document.getElementById('reset-modal').classList.remove('hidden'); }
    function confirmReset() { document.getElementById('reset-modal').classList.add('hidden'); startGame(); }
    function closeReset() { document.getElementById('reset-modal').classList.add('hidden'); }
</script>
</body>

</html>
