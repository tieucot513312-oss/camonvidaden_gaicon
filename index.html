<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <title>Game Anh T√†i V28 - Final + Card Back Feature</title>
    <style>
        :root { 
            --bg: #0a0a0a; 
            --accent: #f1c40f; 
            --card-w: 72px; 
            --card-h: 100px; 
            --panel-bg: #111;
        }
        body { font-family: 'Segoe UI', sans-serif; background: var(--bg); color: white; margin: 0; overflow: hidden; }
        
        /* ADMIN - GI·ªÆ NGUY√äN */
        #admin-panel { background: #1a1a1a; padding: 15px; border-bottom: 3px solid #333; height: auto; max-height: 90vh; overflow-y: auto; z-index: 1000; position: relative; }
        .admin-grid { display: grid; grid-template-columns: 1.2fr 1fr 1fr; gap: 15px; }
        .box { background: #222; padding: 12px; border-radius: 8px; border: 1px solid #444; }
        .scroll-v { height: 350px; overflow-y: auto; background: #000; padding: 8px; border-radius: 5px; scrollbar-width: thin; }
        .team-item { background: #333; margin-bottom: 5px; padding: 8px; border-radius: 5px; border-left: 3px solid var(--accent); }

        /* GAME LAYOUT */
        #game-screen { 
            display: grid; 
            grid-template-columns: 260px 1fr 240px; 
            height: 100vh; 
            background: #050505; 
        }
        
        /* C·ªòT TR√ÅI: LU·∫¨T CH∆†I */
        .rules-sidebar {
            background: var(--panel-bg);
            border-right: 1px solid #333;
            padding: 15px;
            overflow-y: auto;
            font-size: 13px;
            color: #ddd;
            line-height: 1.5;
            scrollbar-width: thin;
        }
        .rules-sidebar h3 { color: var(--accent); margin-top: 0; text-align: center; border-bottom: 2px solid #333; padding-bottom: 10px; }
        .rules-sidebar ul { padding-left: 20px; margin: 5px 0; }
        .rules-sidebar li { margin-bottom: 5px; }

        /* C·ªòT GI·ªÆA: PLAY MAIN */
        .play-main { 
            display: flex; 
            flex-direction: column; 
            height: 100vh; 
            position: relative; 
            overflow: hidden; 
            justify-content: center; 
            align-items: center;
            gap: 15px; 
        }
        
        /* UI CONTROL (TIMING & TURN) */
        .right-controls {
            position: absolute;
            right: 10px;
            top: 50%;
            transform: translateY(-50%);
            display: flex;
            flex-direction: column;
            gap: 15px;
            align-items: center;
            z-index: 100;
        }

        .circle-ui {
            width: 70px; height: 70px;
            border-radius: 50%;
            background: #222;
            border: 3px solid #444;
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            font-weight: bold;
            box-shadow: 0 4px 10px rgba(0,0,0,0.5);
        }

        #timer-val { font-size: 32px; color: var(--accent); }
        .timer-label { font-size: 8px; color: #888; margin-top: -5px; }

        #turn-indicator { font-size: 12px; text-align: center; line-height: 1.2; }
        .p-active { border-color: #2ecc71; color: #2ecc71; box-shadow: 0 0 10px rgba(46, 204, 113, 0.3); }
        .ai-active { border-color: #ff4757; color: #ff4757; box-shadow: 0 0 10px rgba(255, 71, 87, 0.3); }

        /* DRAW PILE - C√ì ·∫¢NH M·∫∂T SAU */
        #draw-pile {
            width: 75px; height: 105px;
            border: 2px solid #444; /* ƒê·ªïi th√†nh solid ƒë·ªÉ ƒë·∫πp h∆°n khi c√≥ ·∫£nh */
            border-radius: 8px;
            cursor: pointer;
            background-color: #1a1a1a;
            background-size: cover;
            background-position: center;
            display: flex;
            justify-content: center;
            align-items: center;
            transition: 0.2s;
            position: relative;
        }
        #draw-pile:hover { border-color: white; transform: scale(1.05); }
        /* S·ªë l∆∞·ª£ng b√†i c√≤n l·∫°i hi·ªÉn th·ªã r√µ tr√™n n·ªÅn ·∫£nh */
        #draw-count { 
            font-size: 24px; 
            font-weight: bold; 
            color: #fff; 
            text-shadow: 0 0 5px #000, 0 0 10px #000;
            z-index: 2;
        }

        /* AREAS */
        .play-area { 
            display: flex; flex-direction: column; 
            justify-content: center; align-items: center; 
            padding: 0; width: 100%; flex: 0 0 auto; 
        }
        
        .card-row-scroll { 
            display: flex; flex-wrap: nowrap; gap: 8px; 
            overflow-x: auto; overflow-y: hidden;
            width: 100%; max-width: 650px; 
            padding: 8px 2px; min-height: 115px; 
            scrollbar-width: thin; align-items: center;
            justify-content: flex-start; margin: 0 auto; 
        }

        .captured-zone { width: 95%; max-width: 650px; display: flex; flex-direction: column; gap: 2px; margin: 0 auto; }
        .captured-list { 
            display: flex; gap: 4px; overflow-x: auto; 
            width: 100%; height: 75px; 
            background: rgba(255,255,255,0.03); 
            border-radius: 5px; padding: 4px; align-items: center; scrollbar-width: thin; 
        }
        .zone-label { font-size: 11px; color: var(--accent); font-weight: bold; margin-left: 5px; display: flex; justify-content: space-between; padding-right: 10px;}

        /* CARDS */
        .card { width: var(--card-w); height: var(--card-h); background: #fff; border-radius: 6px; overflow: hidden; cursor: pointer; transition: 0.2s; border: 2px solid transparent; flex-shrink: 0; position: relative; }
        .card img { width: 100%; height: 100%; object-fit: cover; pointer-events: none; } 
        /* Ch·ªânh l·∫°i img height 100% cho tr∆∞·ªùng h·ª£p m·∫∑t sau, class con s·∫Ω override sau */
        
        .card .c-img-front { height: 78%; } /* ·∫¢nh m·∫∑t tr∆∞·ªõc ch·ªâ l·∫•y 78% */
        .card .c-name { height: 22%; color: #000; font-size: 9px; font-weight: bold; text-align: center; display: flex; align-items: center; justify-content: center; background: #fff; padding: 0 2px; line-height: 1.1; }
        
        .card.selected { transform: scale(1.05); border-color: var(--accent); z-index: 10; }
        .card.highlight { border-color: #2ecc71; animation: pulse 1s infinite; }
        .card.team-done { border-color: #ff4757; box-shadow: 0 0 5px #ff4757; }
        @keyframes pulse { 0% { opacity: 0.7; } 100% { opacity: 1; } }

        .card-mini { width: 45px; height: 64px; border-radius: 4px; flex-shrink: 0; }
        .card-mini .c-name { font-size: 7px; display: flex; height: 25%; }
        .card-mini .c-img-front { height: 75%; }

        /* MODAL */
        .modal-overlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.9); z-index: 999; display: flex; justify-content: center; align-items: center; }
        .modal-content { background: #222; padding: 20px; border-radius: 12px; border: 2px solid var(--accent); text-align: center; width: 300px; }
        
        /* SIDEBAR */
        .side-bar { padding: 10px; background: #111; overflow-y: auto; display: flex; flex-direction: column; gap: 8px; scrollbar-width: thin; border-left: 1px solid #222; }
        .team-tag { padding: 5px; border: 1px solid #333; border-radius: 4px; color: #666; font-size: 11px; text-align: center; background: #151515; }
        .team-tag.active { border-color: #ff4757; color: #ff4757; background: rgba(255, 71, 87, 0.1); font-weight: bold; }
        .btn { color: white; border: none; padding: 8px; border-radius: 5px; cursor: pointer; font-weight: bold; width: 100%; font-size: 12px; }
        .hidden { display: none !important; }
    </style>
</head>
<body>

<div id="decision-modal" class="modal-overlay hidden">
    <div class="modal-content">
        <h3 style="color:var(--accent); margin:0; font-size:16px;">B·∫†N R√öT ƒê∆Ø·ª¢C</h3>
        <img id="modal-img" style="width:90px; height:125px; margin:15px auto; border-radius:6px; border:2px solid white; display:block; object-fit: cover;" src="">
        <div class="modal-btns" style="display:flex; gap:10px;">
            <button class="btn" style="background:#2ecc71; flex:1;" onclick="resolveDraw(true)">OK D·ª®T</button>
            <button class="btn" style="background:#e74c3c; flex:1;" onclick="resolveDraw(false)">T·∫†M XA NHAU</button>
        </div>
    </div>
</div>

<div id="pause-modal" class="modal-overlay hidden">
    <div class="modal-content">
        <h2 style="color:var(--accent); margin-top:0;">‚òï NGH·ªà GI·∫¢I LAO</h2>
        <p style="color:#aaa; font-size:13px; margin-bottom:20px;">Game ƒëang d·ª´ng...</p>
        <button class="btn" style="background:#3498db; padding: 12px;" onclick="resumeGame()">OK TI·∫æP T·ª§C ‚ñ∂</button>
    </div>
</div>

<div id="reset-modal" class="modal-overlay hidden">
    <div class="modal-content">
        <h2 style="color:#ff4757; margin-top:0;">‚ö†Ô∏è C·∫¢NH B√ÅO</h2>
        <p style="color:white; font-size:16px; margin-bottom:20px; font-weight:bold;">Ch·∫Øc ch∆∞a?</p>
        <div style="display:flex; gap:10px;">
            <button class="btn" style="background:#e74c3c; flex:1;" onclick="confirmReset()">CH·∫ÆC R·ªíI</button>
            <button class="btn" style="background:#95a5a6; flex:1;" onclick="closeReset()">TH√îI CH∆†I TI·∫æP</button>
        </div>
    </div>
</div>

<div id="admin-panel">
    <div style="display:flex; justify-content: space-between; align-items: center; margin-bottom:10px;">
        <h2 style="color:var(--accent); margin:0;">GAME ANH T√ÄI V28</h2>
        <div style="display:flex; gap:10px;">
            <button class="btn" style="background:#2ecc71; width:auto; padding:8px 20px;" onclick="startGame()">B·∫ÆT ƒê·∫¶U CH∆†I</button>
            <button class="btn" style="background:#e67e22; width:auto; padding:8px 20px;" onclick="exportFinal()">üì¶ XU·∫§T B·∫¢N</button>
        </div>
    </div>
    <div class="admin-grid">
        <div class="box">
            <strong>1. Link ·∫£nh Anh T√†i:</strong>
            <div style="margin-bottom:10px; border-bottom:1px solid #444; padding-bottom:10px;">
                <strong style="color:#e74c3c;">0. ·∫¢nh m·∫∑t sau b√†i (√öp):</strong>
                <input type="text" id="back-card-url" placeholder="Link ·∫£nh..." oninput="saveBackCard(this.value)" style="width:95%; margin-top:5px; background:#111; color:#fff; border:1px solid #444; padding:4px;">
            </div>
            <div id="at-album" class="scroll-v" style="height:280px;"></div>
        </div>
        <div class="box">
            <strong>2. T·∫°o Team:</strong>
            <input type="text" id="t-name" placeholder="T√™n Team..." style="width:100%; padding:6px; margin:8px 0; background:#111; border:1px solid #444; color:white;">
            <div id="at-checklist" class="scroll-v" style="height:220px;"></div>
            <button class="btn" style="margin-top:8px; background:#3498db;" onclick="addTeam()">+ L∆ØU NH√ìM</button>
        </div>
        <div class="box"><strong>3. Team ƒë√£ l∆∞u:</strong><div id="team-list" class="scroll-v" style="height:320px;"></div></div>
    </div>
</div>

<div id="game-screen" class="hidden">
    <div class="rules-sidebar">
        <h3>LU·∫¨T CH∆†I</h3>
        <strong>1. M·ª•c ti√™u:</strong> Thu th·∫≠p v√† x·∫øp c√°c l√° b√†i theo ƒë√∫ng team (c√≥ li√™n k·∫øt) ƒë·ªÉ ghi ƒëi·ªÉm.<br><br>
        <strong>2. Chia b√†i:</strong>
        <ul>
            <li>M·ªói ng∆∞·ªùi: 7 l√° b√†i tr√™n tay</li>
            <li>Gi·ªØa b√†n: 8 l√° b√†i ng·ª≠a</li>
            <li>Ph·∫ßn c√≤n l·∫°i: b√†i √∫p ƒë·ªÉ r√∫t</li>
        </ul>
        <strong>3. L∆∞·ª£t ch∆°i & c√°ch l·∫•y b√†i:</strong>
        <ul>
            <li>M·ªói l∆∞·ª£t c√≥ 15 gi√¢y.</li>
            <li>To√†n b·ªô c√°c l√° c√πng team (c√≥ li√™n k·∫øt) s·∫Ω ƒë∆∞·ª£c chuy·ªÉn v√†o khu ‚Äúƒê√£ t√¨m th·∫•y nhau‚Äù.</li>
            <li><strong>H·∫øt b√†i tr√™n tay:</strong> b·∫Øt bu·ªôc r√∫t b√†i √∫p.</li>
            <li>Ch·ªâ ƒë∆∞·ª£c ch·ªçn 1 trong 2 h√†nh ƒë·ªông:</li>
            <li><em>a) L·∫•y b√†i tr√™n b√†n:</em> Ch·ªâ ƒë∆∞·ª£c l·∫•y n·∫øu b√†i tr√™n tay ho·∫∑c b√†i ƒë√£ ƒÉn c√≥ li√™n k·∫øt v·ªõi b√†i tr√™n b√†n.</li>
            <li><em>b) R√∫t b√†i √∫p:</em> ƒê∆∞·ª£c r√∫t khi kh√¥ng th·ªÉ ho·∫∑c kh√¥ng mu·ªën ƒÉn b√†i. Sau khi r√∫t c√≥ th·ªÉ gi·ªØ l·∫°i ho·∫∑c ƒë√°nh xu·ªëng.</li>
        </ul>
        <strong>4. K·∫øt th√∫c & T√≠nh ƒëi·ªÉm:</strong><br>
        Game k·∫øt th√∫c khi h·∫øt b√†i ho·∫∑c b·∫ø t·∫Øc.
        <ul>
            <li>M·ªói li√™n k·∫øt: +1 ƒëi·ªÉm</li>
            <li>M·ªói team ƒë·ªß: +5 ƒëi·ªÉm</li>
            <li>B√†i l·∫ª (kh√¥ng li√™n k·∫øt): -2 ƒëi·ªÉm</li>
        </ul>
    </div>

    <div class="play-main">
        <div class="play-area">
            <div id="ai-hand" class="card-row-scroll"></div>
            <div class="captured-zone">
                <div class="zone-label"><span>ƒê√£ t√¨m th·∫•y nhau </span> <span id="score-ai" style="color:#ff4757">0 ƒëi·ªÉm</span></div>
                <div id="ai-captured" class="captured-list"></div>
            </div>
        </div>

        <div class="play-area">
            <div id="board" class="card-row-scroll" style="margin-top:10px; margin-bottom:10px;"></div>
        </div>

        <div class="play-area">
            <div class="captured-zone">
                <div class="zone-label"><span>ƒê√£ t√¨m th·∫•y nhau </span> <span id="score-p" style="color:#2ecc71">0 ƒëi·ªÉm</span></div>
                <div id="p-captured" class="captured-list"></div>
            </div>
            <div id="p-hand" class="card-row-scroll"></div>
        </div>

        <div class="right-controls">
            <div class="circle-ui">
                <div id="timer-val">15</div>
                <div class="timer-label">GI√ÇY</div>
            </div>
            
            <div id="turn-circle" class="circle-ui p-active">
                <div id="turn-indicator">GAI<br>CON</div>
            </div>

            <div style="text-align:center;">
                <div id="draw-pile" onclick="playerDraw()">
                    <span id="draw-count"></span>
                </div>
                <div style="font-size:10px; color:#888; margin-top:5px; font-weight:bold;">R√öT B√ÄI</div>
            </div>
        </div>
    </div>

    <div class="side-bar">
        <h4 style="margin:0; color:var(--accent); text-align:center; font-size:14px;">TI·∫æN ƒê·ªò TEAM</h4>
        <div id="side-teams" class="scroll-v" style="height:450px; background:transparent;"></div>
        <button class="btn" style="background:#3498db; margin-top:10px;" onclick="togglePause()">Ngh·ªâ m·ªát x√≠u ƒëi</button>
        <button class="btn" style="background:#9b59b6;" onclick="resetGame()">Xu qu√° l√†m l·∫°i</button>
    </div>
</div>

<script>
    const AT_NAMES = ["H·ªìng S∆°n","B·∫±ng Ki·ªÅu","T·ª± Long","Phan ƒêinh T√πng","Tu·∫•n H∆∞ng","ƒêinh Ti·∫øn ƒê·∫°t","Ph·∫°m Kh√°nh H∆∞ng","Ti·∫øn Lu·∫≠t","Th√†nh Trung","ƒêƒÉng Kh√¥i","Tr∆∞∆°ng Th·∫ø Vinh","H√† L√™","ƒê·ªó Ho√†ng Hi·ªáp","Thanh Duy","Qu·ªëc Thi√™n","Binz","C∆∞·ªùng Seven","Nguy·ªÖn Tr·∫ßn Duy Nh·∫•t","Jun Ph·∫°m","Neko L√™","TƒÉng Ph√∫c","Thi√™n Minh","BB Tr·∫ßn","Li√™n B·ªânh Ph√°t","S.T S∆°n Th·∫°ch","Rhymastic","·ª®ng Duy Ki√™n","(S)TRONG Tr·ªçng Hi·∫øu","Soobin Ho√†ng S∆°n","Kay Tr·∫ßn","B√πi C√¥ng Nam","Duy Kh√°nh","HuyR","Anh Tu·∫•n","SLIMV","ƒêinh H√† Uy√™n Th∆∞","Vƒ© Khang","Long Kenji","Kh√°nh Vy","Nh√† ƒêam M√™","Nh√† KK","Nh√† Sao S√°ng","Nh√† T√°i Sinh","Nh√† Ng≈© H√†nh","Nh√† H√°t","Nh√† Xu√¢n H·∫° Thu ƒê√¥ng","Nh√† X∆∞∆°ng R·ªìng","Gai Con","Concert","H·ªèa Ca"];
    let teams = [], at_images = {}, isPaused = false;
    let cardBack = ""; // Bi·∫øn ch·ª©a link ·∫£nh m·∫∑t sau
    let game = { pHand:[], aiHand:[], board:[], deck:[], pCap:[], aiCap:[], turn:'p', selected:null, time:15, iv:null, tempDraw: null };

    function drive(url) {
        if(!url || !url.includes('drive.google.com')) return url;
        let id = url.split('/d/')[1]?.split('/')[0] || url.split('id=')[1]?.split('&')[0];
        return `https://lh3.googleusercontent.com/d/${id}`;
    }

    window.onload = () => {
        const saved = localStorage.getItem('at_v23_data');
        if(saved) { 
            let data = JSON.parse(saved); 
            at_images = data.images || {}; 
            teams = data.teams || []; 
            cardBack = data.cardBack || ""; // Load ·∫£nh m·∫∑t sau
        }
        renderAdmin();
    };

    function renderAdmin() {
        document.getElementById('back-card-url').value = cardBack; // Hi·ªÉn th·ªã link ƒë√£ l∆∞u
        document.getElementById('at-album').innerHTML = AT_NAMES.map((n, i) => `<div style="font-size:10px; margin-bottom:3px;">${i+1}. ${n} <input type="text" value="${at_images[i+1] || ''}" oninput="at_images[${i+1}]=this.value;saveData()" style="width:60%; background:#111; color:#fff; border:1px solid #444; font-size:10px;"></div>`).join('');
        document.getElementById('at-checklist').innerHTML = AT_NAMES.map((n, i) => `<div style="font-size:12px;"><input type="checkbox" value="${i+1}" class="chk-at"> ${n}</div>`).join('');
        renderTeamList();
    }

    function addTeam() {
        const name = document.getElementById('t-name').value;
        const ids = Array.from(document.querySelectorAll('.chk-at:checked')).map(cb => parseInt(cb.value));
        if(!name || ids.length < 2) return alert("Thi·∫øu t√™n ho·∫∑c th√†nh vi√™n!");
        teams.push({ name, members: ids });
        document.getElementById('t-name').value = "";
        document.querySelectorAll('.chk-at').forEach(c => c.checked = false);
        renderTeamList(); saveData();
    }

    function renderTeamList() {
        document.getElementById('team-list').innerHTML = teams.map((t, i) => `<div class="team-item"><strong style="font-size:12px; color:var(--accent);">${t.name}</strong><span onclick="teams.splice(${i},1);renderTeamList();saveData()" style="color:#ff4757; cursor:pointer; float:right;">X</span><div style="font-size:10px; color:#aaa; margin-top:3px;">${t.members.map(id => AT_NAMES[id-1]).join(', ')}</div></div>`).join('');
    }

    // H√†m l∆∞u ·∫£nh m·∫∑t sau ri√™ng
    function saveBackCard(val) {
        cardBack = val;
        saveData();
    }

    function saveData() { 
        localStorage.setItem('at_v23_data', JSON.stringify({ 
            images: at_images, 
            teams: teams,
            cardBack: cardBack // L∆∞u th√™m bi·∫øn n√†y
        })); 
    }

    function startGame() {
        document.getElementById('admin-panel').classList.add('hidden');
        document.getElementById('game-screen').classList.remove('hidden');
        let fullDeck = AT_NAMES.map((n, i) => ({ id: i+1, name: n, img: drive(at_images[i+1]) }));
        fullDeck.sort(() => Math.random() - 0.5);
        
        game.pHand = fullDeck.splice(0, 7); 
        game.aiHand = fullDeck.splice(0, 7);
        game.board = fullDeck.splice(0, 8); 
        game.deck = fullDeck;
        game.pCap = []; game.aiCap = []; game.turn = 'p';
        
        document.getElementById('side-teams').innerHTML = teams.map(t => `<div id="tag-${t.name.replace(/\s/g,'')}" class="team-tag">${t.name}</div>`).join('');
        updateUI(); startTimer();
    }

    function calculateScore(captured, isFinal = false) {
        let score = 0;
        score += captured.length; 
        teams.forEach(t => {
            if (t.members.every(mId => captured.some(c => c.id === mId))) {
                score += 5;
            }
        });

        if(isFinal) {
            captured.forEach(c => {
                let belongToTeam = teams.filter(t => t.members.includes(c.id));
                let isLinked = false;
                belongToTeam.forEach(t => {
                    if(t.members.every(mId => captured.some(cap => cap.id === mId))) isLinked = true;
                });
                if(!isLinked) score -= 2;
            });
        }
        return score;
    }

    function updateUI() {
        document.getElementById('score-p').innerText = calculateScore(game.pCap) + " ƒëi·ªÉm";
        document.getElementById('score-ai').innerText = calculateScore(game.aiCap) + " ƒëi·ªÉm";

        const turnCircle = document.getElementById('turn-circle');
        const turnText = document.getElementById('turn-indicator');
        if(game.turn === 'p') {
            turnText.innerHTML = "GAI<br>CON";
            turnCircle.className = "circle-ui p-active";
        } else {
            turnText.innerHTML = "ANH<br>T√ÄI";
            turnCircle.className = "circle-ui ai-active";
        }

        // C·∫¨P NH·∫¨T ·∫¢NH CHO N√öT R√öT B√ÄI
        const pileEl = document.getElementById('draw-pile');
        document.getElementById('draw-count').innerText = game.deck.length;
        if(cardBack) {
            pileEl.style.backgroundImage = `url('${drive(cardBack)}')`;
        } else {
            pileEl.style.backgroundImage = 'none';
        }

        const isTeamDone = (cId) => {
            const team = teams.find(t => t.members.includes(cId));
            if(!team) return false;
            return team.members.every(mId => [...game.pCap, ...game.aiCap].some(captured => captured.id === mId));
        };

        const cardHTML = (c, isP) => `<div class="card ${game.selected === c.id ? 'selected' : ''} ${isTeamDone(c.id) ? 'team-done' : ''}" onclick="${isP ? `selectCard(${c.id})` : ''}"><img class="c-img-front" src="${c.img || ''}"><div class="c-name">${c.name}</div></div>`;

        // C·∫¨P NH·∫¨T B√ÄI C·ª¶A AI: HI·ªÇN TH·ªä ·∫¢NH M·∫∂T SAU N·∫æU C√ì
        const aiCardHTML = cardBack 
            ? `<div class="card"><img src="${drive(cardBack)}" style="width:100%; height:100%; object-fit:cover;"></div>`
            : `<div class="card" style="background:#222; border:0;"></div>`;

        document.getElementById('p-hand').innerHTML = game.pHand.map(c => cardHTML(c, true)).join('');
        document.getElementById('ai-hand').innerHTML = game.aiHand.map(() => aiCardHTML).join('');
        
        document.getElementById('board').innerHTML = game.board.map(c => {
            const hasMagnet = game.pCap.some(pc => teams.some(t => t.members.includes(pc.id) && t.members.includes(c.id)));
            return `<div class="card ${hasMagnet ? 'highlight' : ''}" onclick="takeCard(${c.id})"><img class="c-img-front" src="${c.img}"><div class="c-name">${c.name}</div></div>`;
        }).join('');

        const mini = (c) => `<div class="card card-mini ${isTeamDone(c.id) ? 'team-done' : ''}"><img class="c-img-front" src="${c.img}"><div class="c-name">${c.name}</div></div>`;
        document.getElementById('p-captured').innerHTML = game.pCap.map(mini).join('');
        document.getElementById('ai-captured').innerHTML = game.aiCap.map(mini).join('');
        
        teams.forEach(t => {
            const ok = t.members.every(mId => [...game.pCap, ...game.aiCap].some(c => c.id === mId));
            const el = document.getElementById(`tag-${t.name.replace(/\s/g,'')}`);
            if(el) el.className = ok ? 'team-tag active' : 'team-tag';
        });

        checkEndGame();
    }

    function selectCard(id) { 
        if(game.turn === 'p') { game.selected = (game.selected === id) ? null : id; updateUI(); } 
    }

    function takeCard(bId) {
        if(game.turn !== 'p' || isPaused || game.tempDraw) return;
        
        if (game.pHand.length === 0 && game.deck.length > 0) {
            alert("H·∫øt b√†i tr√™n tay! B·∫°n b·∫Øt bu·ªôc ph·∫£i R√öT B√ÄI.");
            return;
        }

        const bc = game.board.find(x => x.id === bId);
        const magnetMatch = game.pCap.some(pc => teams.some(t => t.members.includes(pc.id) && t.members.includes(bId)));
        
        if(magnetMatch) { 
            game.pCap.push(bc); 
            game.board = game.board.filter(x => x.id !== bId); 
            nextTurn(); return; 
        }

        if(game.selected) {
            const isMatch = teams.some(t => t.members.includes(game.selected) && t.members.includes(bId));
            if(isMatch) {
                game.pCap.push(bc, game.pHand.find(x => x.id === game.selected));
                game.board = game.board.filter(x => x.id !== bId);
                game.pHand = game.pHand.filter(x => x.id !== game.selected);
                game.selected = null; nextTurn();
            }
        }
    }

    function playerDraw() {
        if(game.turn !== 'p' || isPaused || game.deck.length === 0) return;
        clearInterval(game.iv);
        game.tempDraw = game.deck.shift();
        document.getElementById('decision-modal').classList.remove('hidden');
        document.getElementById('modal-img').src = game.tempDraw.img;
    }

    function resolveDraw(isKeep) {
        document.getElementById('decision-modal').classList.add('hidden');
        let c = game.tempDraw;
        if(isKeep) {
            let match = game.board.find(bc => teams.some(t => t.members.includes(c.id) && t.members.includes(bc.id)));
            if(match) { 
                game.pCap.push(c, match); 
                game.board = game.board.filter(x => x.id !== match.id); 
            } else {
                game.pHand.push(c);
            }
        } else {
            game.board.push(c);
        }
        game.tempDraw = null; nextTurn();
    }

    function startTimer() {
        clearInterval(game.iv); game.time = 15;
        document.getElementById('timer-val').innerText = game.time;
        game.iv = setInterval(() => {
            if(!isPaused) {
                game.time--; if(game.time < 0) game.time = 0;
                document.getElementById('timer-val').innerText = game.time;
                if(game.turn === 'ai' && game.time === 7) aiMove();
                if(game.time <= 0) nextTurn();
            }
        }, 1000);
    }

    function nextTurn() { game.turn = (game.turn === 'p' ? 'ai' : 'p'); updateUI(); startTimer(); }

    function aiMove() {
        if (game.aiHand.length === 0 && game.deck.length > 0) {
             let c = game.deck.shift();
             let bcIdx = game.board.findIndex(bc => teams.some(t => t.members.includes(c.id) && t.members.includes(bc.id)));
             if(bcIdx > -1) game.aiCap.push(c, game.board.splice(bcIdx,1)[0]); else game.aiHand.push(c);
             nextTurn();
             return;
        }

        let magnetIdx = game.board.findIndex(bc => game.aiCap.some(ac => teams.some(t => t.members.includes(ac.id) && t.members.includes(bc.id))));
        if(magnetIdx > -1) game.aiCap.push(game.board.splice(magnetIdx,1)[0]);
        else {
            let eaten = false;
            for(let bc of game.board) {
                let mIdx = game.aiHand.findIndex(ah => teams.some(t => t.members.includes(bc.id) && t.members.includes(ah.id)));
                if(mIdx > -1) { game.aiCap.push(bc, game.aiHand.splice(mIdx,1)[0]); game.board = game.board.filter(x => x.id !== bc.id); eaten = true; break; }
            }
            if(!eaten && game.deck.length > 0) {
                let c = game.deck.shift();
                let bcIdx = game.board.findIndex(bc => teams.some(t => t.members.includes(c.id) && t.members.includes(bc.id)));
                if(bcIdx > -1) game.aiCap.push(c, game.board.splice(bcIdx,1)[0]); else game.aiHand.push(c);
            }
        }
        nextTurn();
    }

    function checkEndGame() {
        const cond1 = game.board.length === 0 && game.deck.length === 0;
        let canMove = false;
        if (game.deck.length === 0 && game.board.length > 0) {
             if (game.pHand.some(h => game.board.some(b => teams.some(t => t.members.includes(h.id) && t.members.includes(b.id))))) canMove = true;
             if (game.pCap.some(c => game.board.some(b => teams.some(t => t.members.includes(c.id) && t.members.includes(b.id))))) canMove = true;
             if (game.aiHand.some(h => game.board.some(b => teams.some(t => t.members.includes(h.id) && t.members.includes(b.id))))) canMove = true;
             if (game.aiCap.some(c => game.board.some(b => teams.some(t => t.members.includes(c.id) && t.members.includes(b.id))))) canMove = true;
        } else {
            canMove = true;
        }
        const cond3 = game.deck.length === 0 && (game.pHand.length === 0 || game.aiHand.length === 0);

        if (cond1 || (!canMove && game.deck.length === 0) || (cond3 && !canMove)) {
            clearInterval(game.iv);
            let pFinal = calculateScore(game.pCap, true);
            let aiFinal = calculateScore(game.aiCap, true);
            let msg = `K·∫æT TH√öC V√ÅN ƒê·∫§U!\n\nB·∫°n: ${pFinal} ƒëi·ªÉm\nAnh T√†i: ${aiFinal} ƒëi·ªÉm\n\n`;
            msg += (pFinal > aiFinal) ? "Ch√∫c m·ª´ng Gai Con!" : (pFinal < aiFinal) ? "Thua keo n√†y ta b√†y keo kh√°c!" : "C·∫£m ∆°n v√¨ ƒë√£ b·∫±ng ƒëi·ªÉm.";
            setTimeout(() => alert(msg), 500);
        }
    }

    function togglePause() { isPaused = true; document.getElementById('pause-modal').classList.remove('hidden'); }
    function resumeGame() { isPaused = false; document.getElementById('pause-modal').classList.add('hidden'); }
    function resetGame() { document.getElementById('reset-modal').classList.remove('hidden'); }
    function confirmReset() { document.getElementById('reset-modal').classList.add('hidden'); clearInterval(game.iv); startGame(); }
    function closeReset() { document.getElementById('reset-modal').classList.add('hidden'); }
    function exportFinal() { alert("Nh·∫•n Ctrl+S ƒë·ªÉ l∆∞u game v·ªÅ m√°y nha m√°!"); }
</script>
</body>
</html>